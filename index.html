<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZRP URL Shortener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <!-- Redirection Overlay -->
    <div id="redirect-ui" class="hidden fixed inset-0 bg-white z-50 flex flex-col items-center justify-center text-center p-6">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-600 mb-4"></div>
        <h2 class="text-2xl font-bold text-gray-800">Redirecting...</h2>
        <p class="text-gray-500 mt-2">Please wait while we process your secure link.</p>
        <p id="geo-status" class="text-xs text-indigo-400 mt-4 italic"></p>
    </div>

    <!-- Main Shortener UI -->
    <div id="main-ui" class="glass p-8 rounded-3xl shadow-2xl w-full max-w-md">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">
                ZRP Shortener
            </h1>
            <p class="text-gray-500 mt-2">Professional link management</p>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Destination URL</label>
                <input type="url" id="longUrl" placeholder="https://example.com/very/long/path" 
                    class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all">
            </div>

            <button onclick="createShortLink()" id="btn-shorten"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-all transform active:scale-95 shadow-lg shadow-indigo-200">
                Shorten Link
            </button>

            <div id="result-area" class="hidden mt-6 p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                <p class="text-xs font-semibold text-indigo-400 uppercase tracking-wider mb-2">Your Short Link</p>
                <div class="flex items-center gap-2">
                    <input type="text" id="shortenedUrl" readonly 
                        class="bg-transparent text-indigo-700 font-medium w-full outline-none">
                    <button onclick="copyLink()" class="text-indigo-600 hover:text-indigo-800 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwIFr1oPH4PMqZDI5h2j_5DcNZOsh3YUDrDT5G3cXo8clK-O1DuZTf7bDN9wBqsh7Lq8w/exec';
        const BASE_DOMAIN = 'https://zorpidofficial-github-io.vercel.app/d/'; // Note: In Vercel, this usually translates to /d/:code

        // --- ROUTING LOGIC ---
        async function handleRoute() {
            const path = window.location.pathname;
            const match = path.match(/\/d\/([a-zA-Z0-9]{6})/);

            if (match) {
                const shortCode = match[1];
                showRedirectUI();
                
                try {
                    // 1. Fetch destination
                    const response = await fetch(`${SCRIPT_URL}?code=${shortCode}`);
                    const data = await response.json();

                    if (data.success) {
                        // 2. Attempt Geolocation (Works on Mobile if HTTPS)
                        let lat = null, lng = null;
                        
                        try {
                            const position = await new Promise((resolve, reject) => {
                                document.getElementById('geo-status').innerText = "Requesting location for analytics...";
                                navigator.geolocation.getCurrentPosition(resolve, reject, { 
                                    timeout: 5000,
                                    enableHighAccuracy: false // Faster for mobile
                                });
                            });
                            lat = position.coords.latitude;
                            lng = position.coords.longitude;
                        } catch (err) {
                            console.log("Geo denied or timeout");
                        }

                        // 3. Log click to Sheets
                        await fetch(SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors', // Apps Script POST often needs no-cors
                            body: JSON.stringify({
                                action: 'logClick',
                                shortCode: shortCode,
                                lat: lat,
                                lng: lng
                            })
                        });

                        // 4. Redirect
                        window.location.replace(data.longUrl);
                    } else {
                        alert("Short link not found.");
                        window.location.href = '/';
                    }
                } catch (e) {
                    console.error(e);
                    alert("System error. Please try again.");
                }
            }
        }

        // --- UI LOGIC ---
        function showRedirectUI() {
            document.getElementById('main-ui').classList.add('hidden');
            document.getElementById('redirect-ui').classList.remove('hidden');
        }

        async function createShortLink() {
            const longUrl = document.getElementById('longUrl').value;
            const btn = document.getElementById('btn-shorten');
            
            if (!longUrl || !longUrl.startsWith('http')) {
                alert("Please enter a valid URL starting with http/https");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Creating...";

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'shorten', longUrl: longUrl })
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('result-area').classList.remove('hidden');
                    document.getElementById('shortenedUrl').value = BASE_DOMAIN + data.shortCode;
                }
            } catch (e) {
                alert("Error connecting to server.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Shorten Link";
            }
        }

        function copyLink() {
            const copyText = document.getElementById("shortenedUrl");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            document.execCommand("copy");
            
            const btn = event.currentTarget;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="text-xs text-green-500 font-bold">Copied!</span>';
            setTimeout(() => btn.innerHTML = originalHtml, 2000);
        }

        // Initialize
        window.onload = handleRoute;
    </script>
</body>
</html>
